<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSS to Tailwind AI Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/css.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK Imports -->
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, onSnapshot, collection, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, addDoc, onSnapshot, collection, query, limit, orderBy, setLogLevel };
    </script>
    <style>
        /* Custom dark theme styles and scrollbars */
html, body {
    height: 100%;
}
body {
    font-family: 'Inter', sans-serif;
    background-color: #111827;
}
        
/* Custom scrollbar styling */
textarea::-webkit-scrollbar, pre::-webkit-scrollbar, #history-panel::-webkit-scrollbar {
    width: 8px;
}
        
textarea::-webkit-scrollbar-track, pre::-webkit-scrollbar-track, #history-panel::-webkit-scrollbar-track {
    background: #1F2937;
    border-radius: 4px;
}

textarea::-webkit-scrollbar-thumb, pre::-webkit-scrollbar-thumb, #history-panel::-webkit-scrollbar-thumb {
    background: #4B5563; 
    border-radius: 4px;
}
textarea::-webkit-scrollbar-thumb:hover, pre::-webkit-scrollbar-thumb:hover, #history-panel::-webkit-scrollbar-thumb:hover {
    background: #6B7280; 
}

textarea {
    font-family: 'Fira Code', monospace;
}
        
pre code.hljs {
    background-color: #1F2937; 
    border-radius: 0.5rem;
    padding: 1rem;
    white-space: pre-wrap;
    color: #E5E7EB; 
    font-family: 'Fira Code', monospace;
    line-height: 1.5;
}

pre code.hljs .hljs-comment, pre code.hljs .hljs-selector-class {
    color: inherit !important;
    font-style: normal;
}

/* Simple loader animation */
.loader {
    width: 24px;
    height: 24px;
    border: 3px solid #374151; 
    border-top-color: #60A5FA; 
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

    <div class="flex flex-col lg:flex-row min-h-screen">
        
    <!-- History Sidebar -->
    <aside id="history-panel" class="lg:w-72 w-full bg-gray-800 border-b lg:border-r border-gray-700 p-4 transition-all duration-300 lg:min-h-screen lg:max-h-screen overflow-y-auto">
        <h2 class="text-xl font-bold text-gray-100 mb-4 flex items-center border-b border-gray-700 pb-2"><i class="fas fa-history mr-2 text-purple-400"></i>History</h2>
        <p id="history-status" class="text-sm text-gray-400 mb-4">Loading history...</p>
        <div id="history-list" class="space-y-3">
                <!-- History items will be inserted here -->
        </div>
    </aside>

    <!-- Main Content Wrapper -->
    <div class="flex-1 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
                    
    <header class="text-center mb-8 md:mb-12">
        <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2">CSS to Tailwind AI Converter</h1>
        <p class="text-lg text-gray-400">Securely convert complex CSS, including @media and :hover, using a serverless AI proxy.</p>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        
        <div class="flex flex-col">
        <div class="flex justify-between items-center mb-2">
        <label for="css-input" class="text-sm font-medium text-gray-400">Your CSS</label>
        </div>
                            
    <textarea id="css-input" class="w-full h-96 lg:h-[65vh] p-4 bg-gray-800 border border-gray-700 rounded-lg shadow-inner text-gray-100 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Paste your CSS here to begin.

.my-custom-box {
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #FFEFD5;
    min-height: 400px;
    margin: 20px;
}"></textarea>
    
    <div id="char-count" class="text-right text-xs text-gray-500 mt-1">0 characters</div>
                    </div>
                        
    <div class="flex flex-col">
        <label for="tailwind-output" class="mb-2 text-sm font-medium text-gray-400">Tailwind Output & Analysis</label>
                            
    <div class="w-full h-96 lg:h-[65vh] bg-gray-800 border border-gray-700 rounded-lg shadow-inner overflow-auto">
    <pre id="tailwind-code-container" class="p-0 m-0"><code class="language-plaintext">Output will appear here</code></pre>
                        </div>

    <div id="analysis-box" class="mt-4 p-3 bg-gray-800 border-l-4 border-purple-500 rounded-lg text-sm hidden">
    <p class="font-semibold text-purple-400 mb-1">AI Analysis:</p>
    <p id="analysis-content" class="text-gray-300 italic"></p>
            </div>
        </div>
</main>

<footer class="text-center mt-6 flex flex-wrap items-center justify-center gap-4">
    <button id="convert-btn" class="px-8 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold rounded-lg shadow-lg hover:from-blue-600 hover:to-purple-700 transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">Convert CSS</button>
    <button id="clear-btn" class="px-6 py-3 bg-red-700 text-white font-medium rounded-lg hover:bg-red-600 transition duration-200">Clear Input</button>
    <button id="copy-btn" class="px-6 py-3 bg-gray-700 text-gray-200 font-medium rounded-lg hover:bg-gray-600 transition duration-200 disabled:opacity-50" disabled>Copy Output</button>
    <div id="loader" class="loader hidden"></div>
</footer>

    <div id="error-message" class="text-red-400 text-center mt-4 h-6"></div>
            </div>

        </div>
    </div>
    
    <script>
        
// Global Variables and Constants

//'http://localhost:3000/convert' for local testing
const CONVERSION_ENDPOINT = '/convert'; 
        
// Firebase Setup variables 
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

let db, auth, userId;
let isAuthReady = false; // Flag to ensure Firestore operations wait for auth

// DOM Elements
const cssInput = document.getElementById('css-input');
const tailwindCodeContainer = document.getElementById('tailwind-code-container');
const analysisBox = document.getElementById('analysis-box');
const analysisContent = document.getElementById('analysis-content');
const convertBtn = document.getElementById('convert-btn');
const clearBtn = document.getElementById('clear-btn'); 
const copyBtn = document.getElementById('copy-btn');
const loader = document.getElementById('loader');
const errorMessage = document.getElementById('error-message');
const charCount = document.getElementById('char-count');
const historyList = document.getElementById('history-list');
const historyStatus = document.getElementById('history-status');

//Utility Functions
        
function updateOutputDisplay (tailwindClasses) {
    const codeElement = tailwindCodeContainer.querySelector('code');
        if (codeElement) { codeElement.className = 'language-plaintext'; 
        codeElement.textContent = tailwindClasses;
//Re-run highlighting
    hljs.highlightElement(codeElement);
            }
        }

/** Updates the analysis box */
function updateAnalysis(analysisText) {
    if (analysisText && analysisText.trim()) {
    analysisContent.textContent = analysisText.trim();
    analysisBox.classList.remove('hidden');
    } else {
    analysisBox.classList.add('hidden');
    analysisContent.textContent = '';
            }
        }

//Sets the loading state for the UI 
function setLoading(isLoading) {
    if (isLoading) {
        convertBtn.disabled = true;
        convertBtn.classList.add('hidden');
        loader.classList.remove('hidden');
        clearBtn.disabled = true;
        copyBtn.disabled = true;
        errorMessage.textContent = '';
        analysisBox.classList.add('hidden');
        updateOutputDisplay('/* Converting... (Waiting for secure server response) */');
    } else {
        convertBtn.disabled = false;
        convertBtn.classList.remove('hidden');
        loader.classList.add('hidden');
        clearBtn.disabled = false;
            }
        }

//Firebase/Firestore Logic 
//Initializes Firebase, sets up Auth, and loads history. 
async function initializeFirebase() {
    if (!firebaseConfig || !window.firebase) {
    console.error("Firebase dependencies or config are missing.");
    historyStatus.textContent = "History unavailable: Configuration error.";
    return;
}

    try {
// Set debug level for better logging
        window.firebase.setLogLevel('debug');

    const app = window.firebase.initializeApp(firebaseConfig);
    db = window.firebase.getFirestore(app);
    auth = window.firebase.getAuth(app);
                
// 1. Sign in (using custom token if available, otherwise anonymously)
    if (initialAuthToken) {
        await window.firebase.signInWithCustomToken(auth, initialAuthToken);
    } else {
        await window.firebase.signInAnonymously(auth);
                }

// 2. Auth State Listener
    window.firebase.onAuthStateChanged(auth, (user) => {
    if (user) {
        userId = user.uid;
        isAuthReady = true;
        historyStatus.textContent = `User: ${userId.substring(0, 8)}... (10 recent)`;
        loadHistory();
    } else {
        isAuthReady = false;
        userId = null;
        historyStatus.textContent = "History unavailable: Not signed in.";
        console.log("Signed out or anonymous sign-in failed.");
    }
});

    } catch (error) {
        console.error("Firebase Initialization or Sign-in Failed:", error);
        historyStatus.textContent = `History error: ${error.message}`;
        }
    }
        
//Loads conversion history using a real-time snapshot listener. 
function loadHistory() {
    if (!isAuthReady || !db || !userId) return;

    const historyCollection = window.firebase.collection(db, `/artifacts/${appId}/users/${userId}/conversions`);
// Order by timestamp descending, limit to 10
    const q = window.firebase.query(historyCollection, window.firebase.orderBy('timestamp', 'desc'), window.firebase.limit(10));

// Real-time listener
    window.firebase.onSnapshot(q, (snapshot) => {
    historyList.innerHTML = ''; // Clear existing list
    if (snapshot.empty) {
    historyList.innerHTML = '<p class="text-gray-500 text-sm italic">No conversions saved yet.</p>';
        return;
}

snapshot.forEach((doc) => {
    const data = doc.data();
    const item = createHistoryItem(data.css, data.tailwind);
                    historyList.appendChild(item);
                });
            }, (error) => {
    console.error("Error listening to history:", error);
                historyStatus.textContent = "Error loading history.";
    });
}
        
// Creates a clickable history item element. 
function createHistoryItem(css, tailwind) {
    const item = document.createElement('div');
    item.className = 'p-3 bg-gray-700 hover:bg-gray-600 rounded-lg cursor-pointer transition duration-150 border border-gray-600';
            
// Limit text shown in history
const displayCss = css.replace(/\s+/g, ' ').substring(0, 45);
    item.innerHTML = `<p class="font-semibold text-xs text-gray-200 truncate">${displayCss}${css.length > 45 ? '...' : ''}</p><p class="text-xs text-purple-400 mt-1">Load Conversion</p>`;
            
item.onclick = () => {
    cssInput.value = css;
    updateOutputDisplay(tailwind);
    updateAnalysis(''); // Clear analysis for a re-convert
    copyBtn.disabled = false;
    errorMessage.textContent = '';
    updateCharCount();
};
    return item;
    }

// Saves a new conversion to Firestore. 
    async function saveConversion(css, tailwind, analysis) {
    if (!isAuthReady || !db || !userId) {
        console.warn("User not authenticated, skipping save.");
        return;
}

    const newConversion = {
        css: css,
        tailwind: tailwind,
        analysis: analysis,
        timestamp: Date.now()
    };

    try {
        const historyCollection = window.firebase.collection(db, `/artifacts/${appId}/users/${userId}/conversions`);
    await window.firebase.addDoc(historyCollection, newConversion);
// The history list will automatically update via onSnapshot
        } catch (error) {
            console.error("Failed to save conversion:", error);
            }
        }

//Main Application Logic 
    
function updateCharCount() {
    charCount.textContent = `${cssInput.value.length} characters`;
}

// Main function to handle the conversion process 
async function handleConvert() {

const cssCode = cssInput.value.trim();
    if (!cssCode) {
        errorMessage.textContent = 'Please enter some CSS code to convert.';
        return;
    }

     setLoading(true);

try {
    const response = await fetch(CONVERSION_ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ cssCode: cssCode }),
});

    const result = await response.json();

if (response.ok) {
    const tailwindClasses = result.output || "Error: Conversion output missing.";
    const analysisText = result.analysis || "No specific analysis provided by AI.";

    updateOutputDisplay(tailwindClasses);
    updateAnalysis(analysisText);
    copyBtn.disabled = false;
                    
// Save successful conversion to history
    await saveConversion(cssCode, tailwindClasses, analysisText);
    } else {
const errorMsg = result.error || "Unknown server error.";
errorMessage.textContent = `Conversion failed. Details: ${errorMsg}`;
updateOutputDisplay(`/* Error: ${errorMsg} */`);
updateAnalysis('');
}

    } catch (error) {
        console.error("Fetch Error:", error);
        errorMessage.textContent = `An unexpected error occurred: ${error.message}`;
        updateOutputDisplay('/* Error: Failed to connect to proxy server. */');
        updateAnalysis('');
    } finally {
        setLoading(false);
    }
}

// Handles copying the output to the clipboard 
function handleCopy() {
    const textToCopy = tailwindCodeContainer.textContent;
            
    const tempTextArea = document.createElement('textarea');
    tempTextArea.value = textToCopy;
    document.body.appendChild(tempTextArea);
    tempTextArea.select();
    
    try {
        document.execCommand('copy');
        copyBtn.textContent = 'Output Copied!';
                
    setTimeout(() => {
        copyBtn.textContent = 'Copy Output';
}, 2000);
    } catch (err) {
        console.error('Failed to copy text: ', err);
        errorMessage.textContent = 'Failed to copy to clipboard.';
}
            
    document.body.removeChild(tempTextArea);
        }

//Event Listeners and Initialization 
        
    document.addEventListener('DOMContentLoaded', () => {
// Initiate conversion
    convertBtn.addEventListener('click', handleConvert);

// Copy to clipboard
    opyBtn.addEventListener('click', handleCopy);
            
// Clear button handler
    clearBtn.addEventListener('click', () => {
    cssInput.value = '';
    updateCharCount();
    updateOutputDisplay('/* Output will appear here */');
    updateAnalysis('');
    copyBtn.disabled = true;
    errorMessage.textContent = '';
    });

// Live character count update
    cssInput.addEventListener('input', updateCharCount);
    updateCharCount();

// Initialize Firebase and History
    initializeFirebase();
        });

    </script>
</body>
</html>